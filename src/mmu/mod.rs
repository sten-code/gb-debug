use crate::cartridge::Cartridge;
use crate::gbmode::GbMode;
use crate::io::joypad::Joypad;
use crate::mmu::timer::Timer;
use crate::ppu::PPU;
use crate::io::sound::{AudioPlayer, Sound};
use crate::audio::CpalPlayer;

mod timer;

#[inline(always)]
fn bit(value: bool, position: u8) -> u8 {
    if value { 1 << position } else { 0 }
}

#[inline(always)]
fn is_set(byte: u8, position: u8) -> bool {
    (byte >> position) & 1 == 1
}

#[derive(PartialEq)]
enum DMAType {
    NoDMA,
    GDMA,
    HDMA,
}

pub const DMG_BOOT_ROM: [u8; 256] = [0x31, 0xfe, 0xff, 0xaf, 0x21, 0xff, 0x9f, 0x32, 0xcb, 0x7c, 0x20, 0xfb, 0x21, 0x26, 0xff, 0xe, 0x11, 0x3e, 0x80, 0x32, 0xe2, 0xc, 0x3e, 0xf3, 0xe2, 0x32, 0x3e, 0x77, 0x77, 0x3e, 0xfc, 0xe0, 0x47, 0x11, 0x4, 0x1, 0x21, 0x10, 0x80, 0x1a, 0xcd, 0x95, 0x0, 0xcd, 0x96, 0x0, 0x13, 0x7b, 0xfe, 0x34, 0x20, 0xf3, 0x11, 0xd8, 0x0, 0x6, 0x8, 0x1a, 0x13, 0x22, 0x23, 0x5, 0x20, 0xf9, 0x3e, 0x19, 0xea, 0x10, 0x99, 0x21, 0x2f, 0x99, 0xe, 0xc, 0x3d, 0x28, 0x8, 0x32, 0xd, 0x20, 0xf9, 0x2e, 0xf, 0x18, 0xf3, 0x67, 0x3e, 0x64, 0x57, 0xe0, 0x42, 0x3e, 0x91, 0xe0, 0x40, 0x4, 0x1e, 0x2, 0xe, 0xc, 0xf0, 0x44, 0xfe, 0x90, 0x20, 0xfa, 0xd, 0x20, 0xf7, 0x1d, 0x20, 0xf2, 0xe, 0x13, 0x24, 0x7c, 0x1e, 0x83, 0xfe, 0x62, 0x28, 0x6, 0x1e, 0xc1, 0xfe, 0x64, 0x20, 0x6, 0x7b, 0xe2, 0xc, 0x3e, 0x87, 0xe2, 0xf0, 0x42, 0x90, 0xe0, 0x42, 0x15, 0x20, 0xd2, 0x5, 0x20, 0x4f, 0x16, 0x20, 0x18, 0xcb, 0x4f, 0x6, 0x4, 0xc5, 0xcb, 0x11, 0x17, 0xc1, 0xcb, 0x11, 0x17, 0x5, 0x20, 0xf5, 0x22, 0x23, 0x22, 0x23, 0xc9, 0xce, 0xed, 0x66, 0x66, 0xcc, 0xd, 0x0, 0xb, 0x3, 0x73, 0x0, 0x83, 0x0, 0xc, 0x0, 0xd, 0x0, 0x8, 0x11, 0x1f, 0x88, 0x89, 0x0, 0xe, 0xdc, 0xcc, 0x6e, 0xe6, 0xdd, 0xdd, 0xd9, 0x99, 0xbb, 0xbb, 0x67, 0x63, 0x6e, 0xe, 0xec, 0xcc, 0xdd, 0xdc, 0x99, 0x9f, 0xbb, 0xb9, 0x33, 0x3e, 0x3c, 0x42, 0xb9, 0xa5, 0xb9, 0xa5, 0x42, 0x3c, 0x21, 0x4, 0x1, 0x11, 0xa8, 0x0, 0x1a, 0x13, 0xbe, 0x20, 0xfe, 0x23, 0x7d, 0xfe, 0x34, 0x20, 0xf5, 0x6, 0x19, 0x78, 0x86, 0x23, 0x5, 0x20, 0xfb, 0x86, 0x20, 0xfe, 0x3e, 0x1, 0xe0, 0x50];
pub const CGB_BOOT_ROM: [u8; 2304] = [0x31, 0xfe, 0xff, 0x3e, 0x2, 0xc3, 0x7c, 0x0, 0xd3, 0x0, 0x98, 0xa0, 0x12, 0xd3, 0x0, 0x80, 0x0, 0x40, 0x1e, 0x53, 0xd0, 0x0, 0x1f, 0x42, 0x1c, 0x0, 0x14, 0x2a, 0x4d, 0x19, 0x8c, 0x7e, 0x0, 0x7c, 0x31, 0x6e, 0x4a, 0x45, 0x52, 0x4a, 0x0, 0x0, 0xff, 0x53, 0x1f, 0x7c, 0xff, 0x3, 0x1f, 0x0, 0xff, 0x1f, 0xa7, 0x0, 0xef, 0x1b, 0x1f, 0x0, 0xef, 0x1b, 0x0, 0x7c, 0x0, 0x0, 0xff, 0x3, 0xce, 0xed, 0x66, 0x66, 0xcc, 0xd, 0x0, 0xb, 0x3, 0x73, 0x0, 0x83, 0x0, 0xc, 0x0, 0xd, 0x0, 0x8, 0x11, 0x1f, 0x88, 0x89, 0x0, 0xe, 0xdc, 0xcc, 0x6e, 0xe6, 0xdd, 0xdd, 0xd9, 0x99, 0xbb, 0xbb, 0x67, 0x63, 0x6e, 0xe, 0xec, 0xcc, 0xdd, 0xdc, 0x99, 0x9f, 0xbb, 0xb9, 0x33, 0x3e, 0x3c, 0x42, 0xb9, 0xa5, 0xb9, 0xa5, 0x42, 0x3c, 0x58, 0x43, 0xe0, 0x70, 0x3e, 0xfc, 0xe0, 0x47, 0xcd, 0x75, 0x2, 0xcd, 0x0, 0x2, 0x26, 0xd0, 0xcd, 0x3, 0x2, 0x21, 0x0, 0xfe, 0xe, 0xa0, 0xaf, 0x22, 0xd, 0x20, 0xfc, 0x11, 0x4, 0x1, 0x21, 0x10, 0x80, 0x4c, 0x1a, 0xe2, 0xc, 0xcd, 0xc6, 0x3, 0xcd, 0xc7, 0x3, 0x13, 0x7b, 0xfe, 0x34, 0x20, 0xf1, 0x11, 0x72, 0x0, 0x6, 0x8, 0x1a, 0x13, 0x22, 0x23, 0x5, 0x20, 0xf9, 0xcd, 0xf0, 0x3, 0x3e, 0x1, 0xe0, 0x4f, 0x3e, 0x91, 0xe0, 0x40, 0x21, 0xb2, 0x98, 0x6, 0x4e, 0xe, 0x44, 0xcd, 0x91, 0x2, 0xaf, 0xe0, 0x4f, 0xe, 0x80, 0x21, 0x42, 0x0, 0x6, 0x18, 0xf2, 0xc, 0xbe, 0x20, 0xfe, 0x23, 0x5, 0x20, 0xf7, 0x21, 0x34, 0x1, 0x6, 0x19, 0x78, 0x86, 0x2c, 0x5, 0x20, 0xfb, 0x86, 0x20, 0xfe, 0xcd, 0x1c, 0x3, 0x18, 0x2, 0x0, 0x0, 0xcd, 0xd0, 0x5, 0xaf, 0xe0, 0x70, 0x3e, 0x11, 0xe0, 0x50, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x21, 0x0, 0x80, 0xaf, 0x22, 0xcb, 0x6c, 0x28, 0xfb, 0xc9, 0x2a, 0x12, 0x13, 0xd, 0x20, 0xfa, 0xc9, 0xe5, 0x21, 0xf, 0xff, 0xcb, 0x86, 0xcb, 0x46, 0x28, 0xfc, 0xe1, 0xc9, 0x11, 0x0, 0xff, 0x21, 0x3, 0xd0, 0xe, 0xf, 0x3e, 0x30, 0x12, 0x3e, 0x20, 0x12, 0x1a, 0x2f, 0xa1, 0xcb, 0x37, 0x47, 0x3e, 0x10, 0x12, 0x1a, 0x2f, 0xa1, 0xb0, 0x4f, 0x7e, 0xa9, 0xe6, 0xf0, 0x47, 0x2a, 0xa9, 0xa1, 0xb0, 0x32, 0x47, 0x79, 0x77, 0x3e, 0x30, 0x12, 0xc9, 0x3e, 0x80, 0xe0, 0x68, 0xe0, 0x6a, 0xe, 0x6b, 0x2a, 0xe2, 0x5, 0x20, 0xfb, 0x4a, 0x9, 0x43, 0xe, 0x69, 0x2a, 0xe2, 0x5, 0x20, 0xfb, 0xc9, 0xc5, 0xd5, 0xe5, 0x21, 0x0, 0xd8, 0x6, 0x1, 0x16, 0x3f, 0x1e, 0x40, 0xcd, 0x4a, 0x2, 0xe1, 0xd1, 0xc1, 0xc9, 0x3e, 0x80, 0xe0, 0x26, 0xe0, 0x11, 0x3e, 0xf3, 0xe0, 0x12, 0xe0, 0x25, 0x3e, 0x77, 0xe0, 0x24, 0x21, 0x30, 0xff, 0xaf, 0xe, 0x10, 0x22, 0x2f, 0xd, 0x20, 0xfb, 0xc9, 0xcd, 0x11, 0x2, 0xcd, 0x62, 0x2, 0x79, 0xfe, 0x38, 0x20, 0x14, 0xe5, 0xaf, 0xe0, 0x4f, 0x21, 0xa7, 0x99, 0x3e, 0x38, 0x22, 0x3c, 0xfe, 0x3f, 0x20, 0xfa, 0x3e, 0x1, 0xe0, 0x4f, 0xe1, 0xc5, 0xe5, 0x21, 0x43, 0x1, 0xcb, 0x7e, 0xcc, 0x89, 0x5, 0xe1, 0xc1, 0xcd, 0x11, 0x2, 0x79, 0xd6, 0x30, 0xd2, 0x6, 0x3, 0x79, 0xfe, 0x1, 0xca, 0x6, 0x3, 0x7d, 0xfe, 0xd1, 0x28, 0x21, 0xc5, 0x6, 0x3, 0xe, 0x1, 0x16, 0x3, 0x7e, 0xe6, 0xf8, 0xb1, 0x22, 0x15, 0x20, 0xf8, 0xc, 0x79, 0xfe, 0x6, 0x20, 0xf0, 0x11, 0x11, 0x0, 0x19, 0x5, 0x20, 0xe7, 0x11, 0xa1, 0xff, 0x19, 0xc1, 0x4, 0x78, 0x1e, 0x83, 0xfe, 0x62, 0x28, 0x6, 0x1e, 0xc1, 0xfe, 0x64, 0x20, 0x7, 0x7b, 0xe0, 0x13, 0x3e, 0x87, 0xe0, 0x14, 0xfa, 0x2, 0xd0, 0xfe, 0x0, 0x28, 0xa, 0x3d, 0xea, 0x2, 0xd0, 0x79, 0xfe, 0x1, 0xca, 0x91, 0x2, 0xd, 0xc2, 0x91, 0x2, 0xc9, 0xe, 0x26, 0xcd, 0x4a, 0x3, 0xcd, 0x11, 0x2, 0xcd, 0x62, 0x2, 0xd, 0x20, 0xf4, 0xcd, 0x11, 0x2, 0x3e, 0x1, 0xe0, 0x4f, 0xcd, 0x3e, 0x3, 0xcd, 0x41, 0x3, 0xaf, 0xe0, 0x4f, 0xcd, 0x3e, 0x3, 0xc9, 0x21, 0x8, 0x0, 0x11, 0x51, 0xff, 0xe, 0x5, 0xcd, 0xa, 0x2, 0xc9, 0xc5, 0xd5, 0xe5, 0x21, 0x40, 0xd8, 0xe, 0x20, 0x7e, 0xe6, 0x1f, 0xfe, 0x1f, 0x28, 0x1, 0x3c, 0x57, 0x2a, 0x7, 0x7, 0x7, 0xe6, 0x7, 0x47, 0x3a, 0x7, 0x7, 0x7, 0xe6, 0x18, 0xb0, 0xfe, 0x1f, 0x28, 0x1, 0x3c, 0xf, 0xf, 0xf, 0x47, 0xe6, 0xe0, 0xb2, 0x22, 0x78, 0xe6, 0x3, 0x5f, 0x7e, 0xf, 0xf, 0xe6, 0x1f, 0xfe, 0x1f, 0x28, 0x1, 0x3c, 0x7, 0x7, 0xb3, 0x22, 0xd, 0x20, 0xc7, 0xe1, 0xd1, 0xc1, 0xc9, 0xe, 0x0, 0x1a, 0xe6, 0xf0, 0xcb, 0x49, 0x28, 0x2, 0xcb, 0x37, 0x47, 0x23, 0x7e, 0xb0, 0x22, 0x1a, 0xe6, 0xf, 0xcb, 0x49, 0x20, 0x2, 0xcb, 0x37, 0x47, 0x23, 0x7e, 0xb0, 0x22, 0x13, 0xcb, 0x41, 0x28, 0xd, 0xd5, 0x11, 0xf8, 0xff, 0xcb, 0x49, 0x28, 0x3, 0x11, 0x8, 0x0, 0x19, 0xd1, 0xc, 0x79, 0xfe, 0x18, 0x20, 0xcc, 0xc9, 0x47, 0xd5, 0x16, 0x4, 0x58, 0xcb, 0x10, 0x17, 0xcb, 0x13, 0x17, 0x15, 0x20, 0xf6, 0xd1, 0x22, 0x23, 0x22, 0x23, 0xc9, 0x3e, 0x19, 0xea, 0x10, 0x99, 0x21, 0x2f, 0x99, 0xe, 0xc, 0x3d, 0x28, 0x8, 0x32, 0xd, 0x20, 0xf9, 0x2e, 0xf, 0x18, 0xf3, 0xc9, 0x3e, 0x1, 0xe0, 0x4f, 0xcd, 0x0, 0x2, 0x11, 0x7, 0x6, 0x21, 0x80, 0x80, 0xe, 0xc0, 0x1a, 0x22, 0x23, 0x22, 0x23, 0x13, 0xd, 0x20, 0xf7, 0x11, 0x4, 0x1, 0xcd, 0x8f, 0x3, 0x1, 0xa8, 0xff, 0x9, 0xcd, 0x8f, 0x3, 0x1, 0xf8, 0xff, 0x9, 0x11, 0x72, 0x0, 0xe, 0x8, 0x23, 0x1a, 0x22, 0x13, 0xd, 0x20, 0xf9, 0x21, 0xc2, 0x98, 0x6, 0x8, 0x3e, 0x8, 0xe, 0x10, 0x22, 0xd, 0x20, 0xfc, 0x11, 0x10, 0x0, 0x19, 0x5, 0x20, 0xf3, 0xaf, 0xe0, 0x4f, 0x21, 0xc2, 0x98, 0x3e, 0x8, 0x22, 0x3c, 0xfe, 0x18, 0x20, 0x2, 0x2e, 0xe2, 0xfe, 0x28, 0x20, 0x3, 0x21, 0x2, 0x99, 0xfe, 0x38, 0x20, 0xed, 0x21, 0xd8, 0x8, 0x11, 0x40, 0xd8, 0x6, 0x8, 0x3e, 0xff, 0x12, 0x13, 0x12, 0x13, 0xe, 0x2, 0xcd, 0xa, 0x2, 0x3e, 0x0, 0x12, 0x13, 0x12, 0x13, 0x13, 0x13, 0x5, 0x20, 0xea, 0xcd, 0x62, 0x2, 0x21, 0x4b, 0x1, 0x7e, 0xfe, 0x33, 0x20, 0xb, 0x2e, 0x44, 0x1e, 0x30, 0x2a, 0xbb, 0x20, 0x49, 0x1c, 0x18, 0x4, 0x2e, 0x4b, 0x1e, 0x1, 0x2a, 0xbb, 0x20, 0x3e, 0x2e, 0x34, 0x1, 0x10, 0x0, 0x2a, 0x80, 0x47, 0xd, 0x20, 0xfa, 0xea, 0x0, 0xd0, 0x21, 0xc7, 0x6, 0xe, 0x0, 0x2a, 0xb8, 0x28, 0x8, 0xc, 0x79, 0xfe, 0x4f, 0x20, 0xf6, 0x18, 0x1f, 0x79, 0xd6, 0x41, 0x38, 0x1c, 0x21, 0x16, 0x7, 0x16, 0x0, 0x5f, 0x19, 0xfa, 0x37, 0x1, 0x57, 0x7e, 0xba, 0x28, 0xd, 0x11, 0xe, 0x0, 0x19, 0x79, 0x83, 0x4f, 0xd6, 0x5e, 0x38, 0xed, 0xe, 0x0, 0x21, 0x33, 0x7, 0x6, 0x0, 0x9, 0x7e, 0xe6, 0x1f, 0xea, 0x8, 0xd0, 0x7e, 0xe6, 0xe0, 0x7, 0x7, 0x7, 0xea, 0xb, 0xd0, 0xcd, 0xe9, 0x4, 0xc9, 0x11, 0x91, 0x7, 0x21, 0x0, 0xd9, 0xfa, 0xb, 0xd0, 0x47, 0xe, 0x1e, 0xcb, 0x40, 0x20, 0x2, 0x13, 0x13, 0x1a, 0x22, 0x20, 0x2, 0x1b, 0x1b, 0xcb, 0x48, 0x20, 0x2, 0x13, 0x13, 0x1a, 0x22, 0x13, 0x13, 0x20, 0x2, 0x1b, 0x1b, 0xcb, 0x50, 0x28, 0x5, 0x1b, 0x2b, 0x1a, 0x22, 0x13, 0x1a, 0x22, 0x13, 0xd, 0x20, 0xd7, 0x21, 0x0, 0xd9, 0x11, 0x0, 0xda, 0xcd, 0x64, 0x5, 0xc9, 0x21, 0x12, 0x0, 0xfa, 0x5, 0xd0, 0x7, 0x7, 0x6, 0x0, 0x4f, 0x9, 0x11, 0x40, 0xd8, 0x6, 0x8, 0xe5, 0xe, 0x2, 0xcd, 0xa, 0x2, 0x13, 0x13, 0x13, 0x13, 0x13, 0x13, 0xe1, 0x5, 0x20, 0xf0, 0x11, 0x42, 0xd8, 0xe, 0x2, 0xcd, 0xa, 0x2, 0x11, 0x4a, 0xd8, 0xe, 0x2, 0xcd, 0xa, 0x2, 0x2b, 0x2b, 0x11, 0x44, 0xd8, 0xe, 0x2, 0xcd, 0xa, 0x2, 0xc9, 0xe, 0x60, 0x2a, 0xe5, 0xc5, 0x21, 0xe8, 0x7, 0x6, 0x0, 0x4f, 0x9, 0xe, 0x8, 0xcd, 0xa, 0x2, 0xc1, 0xe1, 0xd, 0x20, 0xec, 0xc9, 0xfa, 0x8, 0xd0, 0x11, 0x18, 0x0, 0x3c, 0x3d, 0x28, 0x3, 0x19, 0x20, 0xfa, 0xc9, 0xcd, 0x1d, 0x2, 0x78, 0xe6, 0xff, 0x28, 0xf, 0x21, 0xe4, 0x8, 0x6, 0x0, 0x2a, 0xb9, 0x28, 0x8, 0x4, 0x78, 0xfe, 0xc, 0x20, 0xf6, 0x18, 0x2d, 0x78, 0xea, 0x5, 0xd0, 0x3e, 0x1e, 0xea, 0x2, 0xd0, 0x11, 0xb, 0x0, 0x19, 0x56, 0x7a, 0xe6, 0x1f, 0x5f, 0x21, 0x8, 0xd0, 0x3a, 0x22, 0x7b, 0x77, 0x7a, 0xe6, 0xe0, 0x7, 0x7, 0x7, 0x5f, 0x21, 0xb, 0xd0, 0x3a, 0x22, 0x7b, 0x77, 0xcd, 0xe9, 0x4, 0xcd, 0x28, 0x5, 0xc9, 0xcd, 0x11, 0x2, 0xfa, 0x43, 0x1, 0xcb, 0x7f, 0x28, 0x4, 0xe0, 0x4c, 0x18, 0x28, 0x3e, 0x4, 0xe0, 0x4c, 0x3e, 0x1, 0xe0, 0x6c, 0x21, 0x0, 0xda, 0xcd, 0x7b, 0x5, 0x6, 0x10, 0x16, 0x0, 0x1e, 0x8, 0xcd, 0x4a, 0x2, 0x21, 0x7a, 0x0, 0xfa, 0x0, 0xd0, 0x47, 0xe, 0x2, 0x2a, 0xb8, 0xcc, 0xda, 0x3, 0xd, 0x20, 0xf8, 0xc9, 0x1, 0xf, 0x3f, 0x7e, 0xff, 0xff, 0xc0, 0x0, 0xc0, 0xf0, 0xf1, 0x3, 0x7c, 0xfc, 0xfe, 0xfe, 0x3, 0x7, 0x7, 0xf, 0xe0, 0xe0, 0xf0, 0xf0, 0x1e, 0x3e, 0x7e, 0xfe, 0xf, 0xf, 0x1f, 0x1f, 0xff, 0xff, 0x0, 0x0, 0x1, 0x1, 0x1, 0x3, 0xff, 0xff, 0xe1, 0xe0, 0xc0, 0xf0, 0xf9, 0xfb, 0x1f, 0x7f, 0xf8, 0xe0, 0xf3, 0xfd, 0x3e, 0x1e, 0xe0, 0xf0, 0xf9, 0x7f, 0x3e, 0x7c, 0xf8, 0xe0, 0xf8, 0xf0, 0xf0, 0xf8, 0x0, 0x0, 0x7f, 0x7f, 0x7, 0xf, 0x9f, 0xbf, 0x9e, 0x1f, 0xff, 0xff, 0xf, 0x1e, 0x3e, 0x3c, 0xf1, 0xfb, 0x7f, 0x7f, 0xfe, 0xde, 0xdf, 0x9f, 0x1f, 0x3f, 0x3e, 0x3c, 0xf8, 0xf8, 0x0, 0x0, 0x3, 0x3, 0x7, 0x7, 0xff, 0xff, 0xc1, 0xc0, 0xf3, 0xe7, 0xf7, 0xf3, 0xc0, 0xc0, 0xc0, 0xc0, 0x1f, 0x1f, 0x1e, 0x3e, 0x3f, 0x1f, 0x3e, 0x3e, 0x80, 0x0, 0x0, 0x0, 0x7c, 0x1f, 0x7, 0x0, 0xf, 0xff, 0xfe, 0x0, 0x7c, 0xf8, 0xf0, 0x0, 0x1f, 0xf, 0xf, 0x0, 0x7c, 0xf8, 0xf8, 0x0, 0x3f, 0x3e, 0x1c, 0x0, 0xf, 0xf, 0xf, 0x0, 0x7c, 0xff, 0xff, 0x0, 0x0, 0xf8, 0xf8, 0x0, 0x7, 0xf, 0xf, 0x0, 0x81, 0xff, 0xff, 0x0, 0xf3, 0xe1, 0x80, 0x0, 0xe0, 0xff, 0x7f, 0x0, 0xfc, 0xf0, 0xc0, 0x0, 0x3e, 0x7c, 0x7c, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x88, 0x16, 0x36, 0xd1, 0xdb, 0xf2, 0x3c, 0x8c, 0x92, 0x3d, 0x5c, 0x58, 0xc9, 0x3e, 0x70, 0x1d, 0x59, 0x69, 0x19, 0x35, 0xa8, 0x14, 0xaa, 0x75, 0x95, 0x99, 0x34, 0x6f, 0x15, 0xff, 0x97, 0x4b, 0x90, 0x17, 0x10, 0x39, 0xf7, 0xf6, 0xa2, 0x49, 0x4e, 0x43, 0x68, 0xe0, 0x8b, 0xf0, 0xce, 0xc, 0x29, 0xe8, 0xb7, 0x86, 0x9a, 0x52, 0x1, 0x9d, 0x71, 0x9c, 0xbd, 0x5d, 0x6d, 0x67, 0x3f, 0x6b, 0xb3, 0x46, 0x28, 0xa5, 0xc6, 0xd3, 0x27, 0x61, 0x18, 0x66, 0x6a, 0xbf, 0xd, 0xf4, 0x42, 0x45, 0x46, 0x41, 0x41, 0x52, 0x42, 0x45, 0x4b, 0x45, 0x4b, 0x20, 0x52, 0x2d, 0x55, 0x52, 0x41, 0x52, 0x20, 0x49, 0x4e, 0x41, 0x49, 0x4c, 0x49, 0x43, 0x45, 0x20, 0x52, 0x7c, 0x8, 0x12, 0xa3, 0xa2, 0x7, 0x87, 0x4b, 0x20, 0x12, 0x65, 0xa8, 0x16, 0xa9, 0x86, 0xb1, 0x68, 0xa0, 0x87, 0x66, 0x12, 0xa1, 0x30, 0x3c, 0x12, 0x85, 0x12, 0x64, 0x1b, 0x7, 0x6, 0x6f, 0x6e, 0x6e, 0xae, 0xaf, 0x6f, 0xb2, 0xaf, 0xb2, 0xa8, 0xab, 0x6f, 0xaf, 0x86, 0xae, 0xa2, 0xa2, 0x12, 0xaf, 0x13, 0x12, 0xa1, 0x6e, 0xaf, 0xaf, 0xad, 0x6, 0x4c, 0x6e, 0xaf, 0xaf, 0x12, 0x7c, 0xac, 0xa8, 0x6a, 0x6e, 0x13, 0xa0, 0x2d, 0xa8, 0x2b, 0xac, 0x64, 0xac, 0x6d, 0x87, 0xbc, 0x60, 0xb4, 0x13, 0x72, 0x7c, 0xb5, 0xae, 0xae, 0x7c, 0x7c, 0x65, 0xa2, 0x6c, 0x64, 0x85, 0x80, 0xb0, 0x40, 0x88, 0x20, 0x68, 0xde, 0x0, 0x70, 0xde, 0x20, 0x78, 0x20, 0x20, 0x38, 0x20, 0xb0, 0x90, 0x20, 0xb0, 0xa0, 0xe0, 0xb0, 0xc0, 0x98, 0xb6, 0x48, 0x80, 0xe0, 0x50, 0x1e, 0x1e, 0x58, 0x20, 0xb8, 0xe0, 0x88, 0xb0, 0x10, 0x20, 0x0, 0x10, 0x20, 0xe0, 0x18, 0xe0, 0x18, 0x0, 0x18, 0xe0, 0x20, 0xa8, 0xe0, 0x20, 0x18, 0xe0, 0x0, 0x20, 0x18, 0xd8, 0xc8, 0x18, 0xe0, 0x0, 0xe0, 0x40, 0x28, 0x28, 0x28, 0x18, 0xe0, 0x60, 0x20, 0x18, 0xe0, 0x0, 0x0, 0x8, 0xe0, 0x18, 0x30, 0xd0, 0xd0, 0xd0, 0x20, 0xe0, 0xe8, 0xff, 0x7f, 0xbf, 0x32, 0xd0, 0x0, 0x0, 0x0, 0x9f, 0x63, 0x79, 0x42, 0xb0, 0x15, 0xcb, 0x4, 0xff, 0x7f, 0x31, 0x6e, 0x4a, 0x45, 0x0, 0x0, 0xff, 0x7f, 0xef, 0x1b, 0x0, 0x2, 0x0, 0x0, 0xff, 0x7f, 0x1f, 0x42, 0xf2, 0x1c, 0x0, 0x0, 0xff, 0x7f, 0x94, 0x52, 0x4a, 0x29, 0x0, 0x0, 0xff, 0x7f, 0xff, 0x3, 0x2f, 0x1, 0x0, 0x0, 0xff, 0x7f, 0xef, 0x3, 0xd6, 0x1, 0x0, 0x0, 0xff, 0x7f, 0xb5, 0x42, 0xc8, 0x3d, 0x0, 0x0, 0x74, 0x7e, 0xff, 0x3, 0x80, 0x1, 0x0, 0x0, 0xff, 0x67, 0xac, 0x77, 0x13, 0x1a, 0x6b, 0x2d, 0xd6, 0x7e, 0xff, 0x4b, 0x75, 0x21, 0x0, 0x0, 0xff, 0x53, 0x5f, 0x4a, 0x52, 0x7e, 0x0, 0x0, 0xff, 0x4f, 0xd2, 0x7e, 0x4c, 0x3a, 0xe0, 0x1c, 0xed, 0x3, 0xff, 0x7f, 0x5f, 0x25, 0x0, 0x0, 0x6a, 0x3, 0x1f, 0x2, 0xff, 0x3, 0xff, 0x7f, 0xff, 0x7f, 0xdf, 0x1, 0x12, 0x1, 0x0, 0x0, 0x1f, 0x23, 0x5f, 0x3, 0xf2, 0x0, 0x9, 0x0, 0xff, 0x7f, 0xea, 0x3, 0x1f, 0x1, 0x0, 0x0, 0x9f, 0x29, 0x1a, 0x0, 0xc, 0x0, 0x0, 0x0, 0xff, 0x7f, 0x7f, 0x2, 0x1f, 0x0, 0x0, 0x0, 0xff, 0x7f, 0xe0, 0x3, 0x6, 0x2, 0x20, 0x1, 0xff, 0x7f, 0xeb, 0x7e, 0x1f, 0x0, 0x0, 0x7c, 0xff, 0x7f, 0xff, 0x3f, 0x0, 0x7e, 0x1f, 0x0, 0xff, 0x7f, 0xff, 0x3, 0x1f, 0x0, 0x0, 0x0, 0xff, 0x3, 0x1f, 0x0, 0xc, 0x0, 0x0, 0x0, 0xff, 0x7f, 0x3f, 0x3, 0x93, 0x1, 0x0, 0x0, 0x0, 0x0, 0x0, 0x42, 0x7f, 0x3, 0xff, 0x7f, 0xff, 0x7f, 0x8c, 0x7e, 0x0, 0x7c, 0x0, 0x0, 0xff, 0x7f, 0xef, 0x1b, 0x80, 0x61, 0x0, 0x0, 0xff, 0x7f, 0x0, 0x7c, 0xe0, 0x3, 0x1f, 0x7c, 0x1f, 0x0, 0xff, 0x3, 0x40, 0x41, 0x42, 0x20, 0x21, 0x22, 0x80, 0x81, 0x82, 0x10, 0x11, 0x12, 0x12, 0xb0, 0x79, 0xb8, 0xad, 0x16, 0x17, 0x7, 0xba, 0x5, 0x7c, 0x13, 0x0, 0x0, 0x0, 0x0];
pub const CGB0_BOOT_ROM: [u8; 2304] = [0x31, 0xfe, 0xff, 0x3e, 0x2, 0xc3, 0x7c, 0x0, 0xd3, 0x0, 0x98, 0xa0, 0x12, 0xd3, 0x0, 0x80, 0x0, 0x40, 0x1e, 0x53, 0xd0, 0x0, 0x1f, 0x42, 0x1c, 0x0, 0x14, 0x2a, 0x4d, 0x19, 0x8c, 0x7e, 0x0, 0x7c, 0x31, 0x6e, 0x4a, 0x45, 0x52, 0x4a, 0x0, 0x0, 0xff, 0x53, 0x1f, 0x7c, 0xff, 0x3, 0x1f, 0x0, 0xff, 0x1f, 0xa7, 0x0, 0xef, 0x1b, 0x1f, 0x0, 0xef, 0x1b, 0x0, 0x7c, 0x0, 0x0, 0xff, 0x3, 0xce, 0xed, 0x66, 0x66, 0xcc, 0xd, 0x0, 0xb, 0x3, 0x73, 0x0, 0x83, 0x0, 0xc, 0x0, 0xd, 0x0, 0x8, 0x11, 0x1f, 0x88, 0x89, 0x0, 0xe, 0xdc, 0xcc, 0x6e, 0xe6, 0xdd, 0xdd, 0xd9, 0x99, 0xbb, 0xbb, 0x67, 0x63, 0x6e, 0xe, 0xec, 0xcc, 0xdd, 0xdc, 0x99, 0x9f, 0xbb, 0xb9, 0x33, 0x3e, 0x3c, 0x42, 0xb9, 0xa5, 0xb9, 0xa5, 0x42, 0x3c, 0x58, 0x43, 0xe0, 0x70, 0x3e, 0xfc, 0xe0, 0x47, 0xcd, 0x75, 0x2, 0xcd, 0x0, 0x2, 0x26, 0xd0, 0xcd, 0x3, 0x2, 0x21, 0x0, 0xfe, 0xe, 0xa0, 0xaf, 0x22, 0xd, 0x20, 0xfc, 0x11, 0x4, 0x1, 0x21, 0x10, 0x80, 0x4c, 0x1a, 0xe2, 0xc, 0xcd, 0xbb, 0x3, 0xcd, 0xbc, 0x3, 0x13, 0x7b, 0xfe, 0x34, 0x20, 0xf1, 0x11, 0x72, 0x0, 0x6, 0x8, 0x1a, 0x13, 0x22, 0x23, 0x5, 0x20, 0xf9, 0xcd, 0xe5, 0x3, 0x3e, 0x1, 0xe0, 0x4f, 0x3e, 0x91, 0xe0, 0x40, 0x21, 0xb2, 0x98, 0x6, 0x4e, 0xe, 0x44, 0xcd, 0x86, 0x2, 0xaf, 0xe0, 0x4f, 0xe, 0x80, 0x21, 0x42, 0x0, 0x6, 0x18, 0xf2, 0xc, 0xbe, 0x20, 0xfe, 0x23, 0x5, 0x20, 0xf7, 0x21, 0x34, 0x1, 0x6, 0x19, 0x78, 0x86, 0x2c, 0x5, 0x20, 0xfb, 0x86, 0x20, 0xfe, 0xcd, 0x11, 0x3, 0x18, 0x2, 0x0, 0x0, 0xcd, 0xd0, 0x5, 0xaf, 0xe0, 0x70, 0x3e, 0x11, 0xe0, 0x50, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x21, 0x0, 0x80, 0xaf, 0x22, 0xcb, 0x6c, 0x28, 0xfb, 0xc9, 0x2a, 0x12, 0x13, 0xd, 0x20, 0xfa, 0xc9, 0xe5, 0x21, 0xf, 0xff, 0xcb, 0x86, 0xcb, 0x46, 0x28, 0xfc, 0xe1, 0xc9, 0x11, 0x0, 0xff, 0x21, 0x3, 0xd0, 0xe, 0xf, 0x3e, 0x30, 0x12, 0x3e, 0x20, 0x12, 0x1a, 0x2f, 0xa1, 0xcb, 0x37, 0x47, 0x3e, 0x10, 0x12, 0x1a, 0x2f, 0xa1, 0xb0, 0x4f, 0x7e, 0xa9, 0xe6, 0xf0, 0x47, 0x2a, 0xa9, 0xa1, 0xb0, 0x32, 0x47, 0x79, 0x77, 0x3e, 0x30, 0x12, 0xc9, 0x3e, 0x80, 0xe0, 0x68, 0xe0, 0x6a, 0xe, 0x6b, 0x2a, 0xe2, 0x5, 0x20, 0xfb, 0x4a, 0x9, 0x43, 0xe, 0x69, 0x2a, 0xe2, 0x5, 0x20, 0xfb, 0xc9, 0xc5, 0xd5, 0xe5, 0x21, 0x0, 0xd8, 0x6, 0x1, 0x16, 0x3f, 0x1e, 0x40, 0xcd, 0x4a, 0x2, 0xe1, 0xd1, 0xc1, 0xc9, 0x3e, 0x80, 0xe0, 0x26, 0xe0, 0x11, 0x3e, 0xf3, 0xe0, 0x12, 0xe0, 0x25, 0x3e, 0x77, 0xe0, 0x24, 0xc9, 0xcd, 0x11, 0x2, 0xcd, 0x62, 0x2, 0x79, 0xfe, 0x38, 0x20, 0x14, 0xe5, 0xaf, 0xe0, 0x4f, 0x21, 0xa7, 0x99, 0x3e, 0x38, 0x22, 0x3c, 0xfe, 0x3f, 0x20, 0xfa, 0x3e, 0x1, 0xe0, 0x4f, 0xe1, 0xc5, 0xe5, 0x21, 0x43, 0x1, 0xcb, 0x7e, 0xcc, 0x89, 0x5, 0xe1, 0xc1, 0xcd, 0x11, 0x2, 0x79, 0xd6, 0x30, 0xd2, 0xfb, 0x2, 0x79, 0xfe, 0x1, 0xca, 0xfb, 0x2, 0x7d, 0xfe, 0xd1, 0x28, 0x21, 0xc5, 0x6, 0x3, 0xe, 0x1, 0x16, 0x3, 0x7e, 0xe6, 0xf8, 0xb1, 0x22, 0x15, 0x20, 0xf8, 0xc, 0x79, 0xfe, 0x6, 0x20, 0xf0, 0x11, 0x11, 0x0, 0x19, 0x5, 0x20, 0xe7, 0x11, 0xa1, 0xff, 0x19, 0xc1, 0x4, 0x78, 0x1e, 0x83, 0xfe, 0x62, 0x28, 0x6, 0x1e, 0xc1, 0xfe, 0x64, 0x20, 0x7, 0x7b, 0xe0, 0x13, 0x3e, 0x87, 0xe0, 0x14, 0xfa, 0x2, 0xd0, 0xfe, 0x0, 0x28, 0xa, 0x3d, 0xea, 0x2, 0xd0, 0x79, 0xfe, 0x1, 0xca, 0x86, 0x2, 0xd, 0xc2, 0x86, 0x2, 0xc9, 0xe, 0x26, 0xcd, 0x3f, 0x3, 0xcd, 0x11, 0x2, 0xcd, 0x62, 0x2, 0xd, 0x20, 0xf4, 0xcd, 0x11, 0x2, 0x3e, 0x1, 0xe0, 0x4f, 0xcd, 0x33, 0x3, 0xcd, 0x36, 0x3, 0xaf, 0xe0, 0x4f, 0xcd, 0x33, 0x3, 0xc9, 0x21, 0x8, 0x0, 0x11, 0x51, 0xff, 0xe, 0x5, 0xcd, 0xa, 0x2, 0xc9, 0xc5, 0xd5, 0xe5, 0x21, 0x40, 0xd8, 0xe, 0x20, 0x7e, 0xe6, 0x1f, 0xfe, 0x1f, 0x28, 0x1, 0x3c, 0x57, 0x2a, 0x7, 0x7, 0x7, 0xe6, 0x7, 0x47, 0x3a, 0x7, 0x7, 0x7, 0xe6, 0x18, 0xb0, 0xfe, 0x1f, 0x28, 0x1, 0x3c, 0xf, 0xf, 0xf, 0x47, 0xe6, 0xe0, 0xb2, 0x22, 0x78, 0xe6, 0x3, 0x5f, 0x7e, 0xf, 0xf, 0xe6, 0x1f, 0xfe, 0x1f, 0x28, 0x1, 0x3c, 0x7, 0x7, 0xb3, 0x22, 0xd, 0x20, 0xc7, 0xe1, 0xd1, 0xc1, 0xc9, 0xe, 0x0, 0x1a, 0xe6, 0xf0, 0xcb, 0x49, 0x28, 0x2, 0xcb, 0x37, 0x47, 0x23, 0x7e, 0xb0, 0x22, 0x1a, 0xe6, 0xf, 0xcb, 0x49, 0x20, 0x2, 0xcb, 0x37, 0x47, 0x23, 0x7e, 0xb0, 0x22, 0x13, 0xcb, 0x41, 0x28, 0xd, 0xd5, 0x11, 0xf8, 0xff, 0xcb, 0x49, 0x28, 0x3, 0x11, 0x8, 0x0, 0x19, 0xd1, 0xc, 0x79, 0xfe, 0x18, 0x20, 0xcc, 0xc9, 0x47, 0xd5, 0x16, 0x4, 0x58, 0xcb, 0x10, 0x17, 0xcb, 0x13, 0x17, 0x15, 0x20, 0xf6, 0xd1, 0x22, 0x23, 0x22, 0x23, 0xc9, 0x3e, 0x19, 0xea, 0x10, 0x99, 0x21, 0x2f, 0x99, 0xe, 0xc, 0x3d, 0x28, 0x8, 0x32, 0xd, 0x20, 0xf9, 0x2e, 0xf, 0x18, 0xf3, 0xc9, 0x3e, 0x1, 0xe0, 0x4f, 0xcd, 0x0, 0x2, 0x11, 0x7, 0x6, 0x21, 0x80, 0x80, 0x6, 0x30, 0xe, 0x4, 0x1a, 0x22, 0x23, 0x22, 0x23, 0x13, 0xd, 0x20, 0xf7, 0x5, 0x20, 0xf2, 0x11, 0x4, 0x1, 0xcd, 0x84, 0x3, 0x1, 0xa8, 0xff, 0x9, 0xcd, 0x84, 0x3, 0x1, 0xf8, 0xff, 0x9, 0x11, 0x72, 0x0, 0xe, 0x8, 0x23, 0x1a, 0x22, 0x13, 0xd, 0x20, 0xf9, 0x21, 0xc2, 0x98, 0x6, 0x8, 0x3e, 0x8, 0xe, 0x10, 0x22, 0xd, 0x20, 0xfc, 0x11, 0x10, 0x0, 0x19, 0x5, 0x20, 0xf3, 0xaf, 0xe0, 0x4f, 0x21, 0xc2, 0x98, 0x3e, 0x8, 0x22, 0x3c, 0xfe, 0x18, 0x20, 0x2, 0x2e, 0xe2, 0xfe, 0x28, 0x20, 0x3, 0x21, 0x2, 0x99, 0xfe, 0x38, 0x20, 0xed, 0x21, 0xd8, 0x8, 0x11, 0x40, 0xd8, 0x6, 0x8, 0x3e, 0xff, 0x12, 0x13, 0x12, 0x13, 0xe, 0x2, 0xcd, 0xa, 0x2, 0x3e, 0x0, 0x12, 0x13, 0x12, 0x13, 0x13, 0x13, 0x5, 0x20, 0xea, 0xcd, 0x62, 0x2, 0x21, 0x4b, 0x1, 0x7e, 0xfe, 0x33, 0x20, 0xb, 0x2e, 0x44, 0x1e, 0x30, 0x2a, 0xbb, 0x20, 0x49, 0x1c, 0x18, 0x4, 0x2e, 0x4b, 0x1e, 0x1, 0x2a, 0xbb, 0x20, 0x3e, 0x2e, 0x34, 0x1, 0x10, 0x0, 0x2a, 0x80, 0x47, 0xd, 0x20, 0xfa, 0xea, 0x0, 0xd0, 0x21, 0xc7, 0x6, 0xe, 0x0, 0x2a, 0xb8, 0x28, 0x8, 0xc, 0x79, 0xfe, 0x4f, 0x20, 0xf6, 0x18, 0x1f, 0x79, 0xd6, 0x41, 0x38, 0x1c, 0x21, 0x16, 0x7, 0x16, 0x0, 0x5f, 0x19, 0xfa, 0x37, 0x1, 0x57, 0x7e, 0xba, 0x28, 0xd, 0x11, 0xe, 0x0, 0x19, 0x79, 0x83, 0x4f, 0xd6, 0x5e, 0x38, 0xed, 0xe, 0x0, 0x21, 0x33, 0x7, 0x6, 0x0, 0x9, 0x7e, 0xe6, 0x1f, 0xea, 0x6, 0xd0, 0xea, 0x8, 0xd0, 0x7e, 0xe6, 0xe0, 0x7, 0x7, 0x7, 0xea, 0x9, 0xd0, 0xea, 0xb, 0xd0, 0xcd, 0xe9, 0x4, 0xc9, 0x11, 0x91, 0x7, 0x21, 0x0, 0xd9, 0xfa, 0xb, 0xd0, 0x47, 0xe, 0x1e, 0xcb, 0x40, 0x20, 0x2, 0x13, 0x13, 0x1a, 0x22, 0x20, 0x2, 0x1b, 0x1b, 0xcb, 0x48, 0x20, 0x2, 0x13, 0x13, 0x1a, 0x22, 0x13, 0x13, 0x20, 0x2, 0x1b, 0x1b, 0xcb, 0x50, 0x28, 0x5, 0x1b, 0x2b, 0x1a, 0x22, 0x13, 0x1a, 0x22, 0x13, 0xd, 0x20, 0xd7, 0x21, 0x0, 0xd9, 0x11, 0x0, 0xda, 0xcd, 0x64, 0x5, 0xc9, 0x21, 0x12, 0x0, 0xfa, 0x5, 0xd0, 0x7, 0x7, 0x6, 0x0, 0x4f, 0x9, 0x11, 0x40, 0xd8, 0x6, 0x8, 0xe5, 0xe, 0x2, 0xcd, 0xa, 0x2, 0x13, 0x13, 0x13, 0x13, 0x13, 0x13, 0xe1, 0x5, 0x20, 0xf0, 0x11, 0x42, 0xd8, 0xe, 0x2, 0xcd, 0xa, 0x2, 0x11, 0x4a, 0xd8, 0xe, 0x2, 0xcd, 0xa, 0x2, 0x2b, 0x2b, 0x11, 0x44, 0xd8, 0xe, 0x2, 0xcd, 0xa, 0x2, 0xc9, 0xe, 0x60, 0x2a, 0xe5, 0xc5, 0x21, 0xe8, 0x7, 0x6, 0x0, 0x4f, 0x9, 0xe, 0x8, 0xcd, 0xa, 0x2, 0xc1, 0xe1, 0xd, 0x20, 0xec, 0xc9, 0xfa, 0x8, 0xd0, 0x11, 0x18, 0x0, 0x3c, 0x3d, 0x28, 0x3, 0x19, 0x20, 0xfa, 0xc9, 0xcd, 0x1d, 0x2, 0x78, 0xe6, 0xff, 0x28, 0xf, 0x21, 0xe4, 0x8, 0x6, 0x0, 0x2a, 0xb9, 0x28, 0x8, 0x4, 0x78, 0xfe, 0xc, 0x20, 0xf6, 0x18, 0x2d, 0x78, 0xea, 0x5, 0xd0, 0x3e, 0x1e, 0xea, 0x2, 0xd0, 0x11, 0xb, 0x0, 0x19, 0x56, 0x7a, 0xe6, 0x1f, 0x5f, 0x21, 0x8, 0xd0, 0x3a, 0x22, 0x7b, 0x77, 0x7a, 0xe6, 0xe0, 0x7, 0x7, 0x7, 0x5f, 0x21, 0xb, 0xd0, 0x3a, 0x22, 0x7b, 0x77, 0xcd, 0xe9, 0x4, 0xcd, 0x28, 0x5, 0xc9, 0xcd, 0x11, 0x2, 0xfa, 0x43, 0x1, 0xcb, 0x7f, 0x28, 0x4, 0xe0, 0x4c, 0x18, 0x28, 0x3e, 0x4, 0xe0, 0x4c, 0x3e, 0x1, 0xe0, 0x6c, 0x21, 0x0, 0xda, 0xcd, 0x7b, 0x5, 0x6, 0x10, 0x16, 0x0, 0x1e, 0x8, 0xcd, 0x4a, 0x2, 0x21, 0x7a, 0x0, 0xfa, 0x0, 0xd0, 0x47, 0xe, 0x2, 0x2a, 0xb8, 0xcc, 0xcf, 0x3, 0xd, 0x20, 0xf8, 0xc9, 0x1, 0xf, 0x3f, 0x7e, 0xff, 0xff, 0xc0, 0x0, 0xc0, 0xf0, 0xf1, 0x3, 0x7c, 0xfc, 0xfe, 0xfe, 0x3, 0x7, 0x7, 0xf, 0xe0, 0xe0, 0xf0, 0xf0, 0x1e, 0x3e, 0x7e, 0xfe, 0xf, 0xf, 0x1f, 0x1f, 0xff, 0xff, 0x0, 0x0, 0x1, 0x1, 0x1, 0x3, 0xff, 0xff, 0xe1, 0xe0, 0xc0, 0xf0, 0xf9, 0xfb, 0x1f, 0x7f, 0xf8, 0xe0, 0xf3, 0xfd, 0x3e, 0x1e, 0xe0, 0xf0, 0xf9, 0x7f, 0x3e, 0x7c, 0xf8, 0xe0, 0xf8, 0xf0, 0xf0, 0xf8, 0x0, 0x0, 0x7f, 0x7f, 0x7, 0xf, 0x9f, 0xbf, 0x9e, 0x1f, 0xff, 0xff, 0xf, 0x1e, 0x3e, 0x3c, 0xf1, 0xfb, 0x7f, 0x7f, 0xfe, 0xde, 0xdf, 0x9f, 0x1f, 0x3f, 0x3e, 0x3c, 0xf8, 0xf8, 0x0, 0x0, 0x3, 0x3, 0x7, 0x7, 0xff, 0xff, 0xc1, 0xc0, 0xf3, 0xe7, 0xf7, 0xf3, 0xc0, 0xc0, 0xc0, 0xc0, 0x1f, 0x1f, 0x1e, 0x3e, 0x3f, 0x1f, 0x3e, 0x3e, 0x80, 0x0, 0x0, 0x0, 0x7c, 0x1f, 0x7, 0x0, 0xf, 0xff, 0xfe, 0x0, 0x7c, 0xf8, 0xf0, 0x0, 0x1f, 0xf, 0xf, 0x0, 0x7c, 0xf8, 0xf8, 0x0, 0x3f, 0x3e, 0x1c, 0x0, 0xf, 0xf, 0xf, 0x0, 0x7c, 0xff, 0xff, 0x0, 0x0, 0xf8, 0xf8, 0x0, 0x7, 0xf, 0xf, 0x0, 0x81, 0xff, 0xff, 0x0, 0xf3, 0xe1, 0x80, 0x0, 0xe0, 0xff, 0x7f, 0x0, 0xfc, 0xf0, 0xc0, 0x0, 0x3e, 0x7c, 0x7c, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x88, 0x16, 0x36, 0xd1, 0xdb, 0xf2, 0x3c, 0x8c, 0x92, 0x3d, 0x5c, 0x58, 0xc9, 0x3e, 0x70, 0x1d, 0x59, 0x69, 0x19, 0x35, 0xa8, 0x14, 0xaa, 0x75, 0x95, 0x99, 0x34, 0x6f, 0x15, 0xff, 0x97, 0x4b, 0x90, 0x17, 0x10, 0x39, 0xf7, 0xf6, 0xa2, 0x49, 0x4e, 0x43, 0x68, 0xe0, 0x8b, 0xf0, 0xce, 0xc, 0x29, 0xe8, 0xb7, 0x86, 0x9a, 0x52, 0x1, 0x9d, 0x71, 0x9c, 0xbd, 0x5d, 0x6d, 0x67, 0x3f, 0x6b, 0xb3, 0x46, 0x28, 0xa5, 0xc6, 0xd3, 0x27, 0x61, 0x18, 0x66, 0x6a, 0xbf, 0xd, 0xf4, 0x42, 0x45, 0x46, 0x41, 0x41, 0x52, 0x42, 0x45, 0x4b, 0x45, 0x4b, 0x20, 0x52, 0x2d, 0x55, 0x52, 0x41, 0x52, 0x20, 0x49, 0x4e, 0x41, 0x49, 0x4c, 0x49, 0x43, 0x45, 0x20, 0x52, 0x7c, 0x8, 0x12, 0xa3, 0xa2, 0x7, 0x87, 0x4b, 0x20, 0x12, 0x65, 0xa8, 0x16, 0xa9, 0x86, 0xb1, 0x68, 0xa0, 0x87, 0x66, 0x12, 0xa1, 0x30, 0x3c, 0x12, 0x85, 0x12, 0x64, 0x1b, 0x7, 0x6, 0x6f, 0x6e, 0x6e, 0xae, 0xaf, 0x6f, 0xb2, 0xaf, 0xb2, 0xa8, 0xab, 0x6f, 0xaf, 0x86, 0xae, 0xa2, 0xa2, 0x12, 0xaf, 0x13, 0x12, 0xa1, 0x6e, 0xaf, 0xaf, 0xad, 0x6, 0x4c, 0x6e, 0xaf, 0xaf, 0x12, 0x7c, 0xac, 0xa8, 0x6a, 0x6e, 0x13, 0xa0, 0x2d, 0xa8, 0x2b, 0xac, 0x64, 0xac, 0x6d, 0x87, 0xbc, 0x60, 0xb4, 0x13, 0x72, 0x7c, 0xb5, 0xae, 0xae, 0x7c, 0x7c, 0x65, 0xa2, 0x6c, 0x64, 0x85, 0x80, 0xb0, 0x40, 0x88, 0x20, 0x68, 0xde, 0x0, 0x70, 0xde, 0x20, 0x78, 0x20, 0x20, 0x38, 0x20, 0xb0, 0x90, 0x20, 0xb0, 0xa0, 0xe0, 0xb0, 0xc0, 0x98, 0xb6, 0x48, 0x80, 0xe0, 0x50, 0x1e, 0x1e, 0x58, 0x20, 0xb8, 0xe0, 0x88, 0xb0, 0x10, 0x20, 0x0, 0x10, 0x20, 0xe0, 0x18, 0xe0, 0x18, 0x0, 0x18, 0xe0, 0x20, 0xa8, 0xe0, 0x20, 0x18, 0xe0, 0x0, 0x20, 0x18, 0xd8, 0xc8, 0x18, 0xe0, 0x0, 0xe0, 0x40, 0x28, 0x28, 0x28, 0x18, 0xe0, 0x60, 0x20, 0x18, 0xe0, 0x0, 0x0, 0x8, 0xe0, 0x18, 0x30, 0xd0, 0xd0, 0xd0, 0x20, 0xe0, 0xe8, 0xff, 0x7f, 0xbf, 0x32, 0xd0, 0x0, 0x0, 0x0, 0x9f, 0x63, 0x79, 0x42, 0xb0, 0x15, 0xcb, 0x4, 0xff, 0x7f, 0x31, 0x6e, 0x4a, 0x45, 0x0, 0x0, 0xff, 0x7f, 0xef, 0x1b, 0x0, 0x2, 0x0, 0x0, 0xff, 0x7f, 0x1f, 0x42, 0xf2, 0x1c, 0x0, 0x0, 0xff, 0x7f, 0x94, 0x52, 0x4a, 0x29, 0x0, 0x0, 0xff, 0x7f, 0xff, 0x3, 0x2f, 0x1, 0x0, 0x0, 0xff, 0x7f, 0xef, 0x3, 0xd6, 0x1, 0x0, 0x0, 0xff, 0x7f, 0xb5, 0x42, 0xc8, 0x3d, 0x0, 0x0, 0x74, 0x7e, 0xff, 0x3, 0x80, 0x1, 0x0, 0x0, 0xff, 0x67, 0xac, 0x77, 0x13, 0x1a, 0x6b, 0x2d, 0xd6, 0x7e, 0xff, 0x4b, 0x75, 0x21, 0x0, 0x0, 0xff, 0x53, 0x5f, 0x4a, 0x52, 0x7e, 0x0, 0x0, 0xff, 0x4f, 0xd2, 0x7e, 0x4c, 0x3a, 0xe0, 0x1c, 0xed, 0x3, 0xff, 0x7f, 0x5f, 0x25, 0x0, 0x0, 0x6a, 0x3, 0x1f, 0x2, 0xff, 0x3, 0xff, 0x7f, 0xff, 0x7f, 0xdf, 0x1, 0x12, 0x1, 0x0, 0x0, 0x1f, 0x23, 0x5f, 0x3, 0xf2, 0x0, 0x9, 0x0, 0xff, 0x7f, 0xea, 0x3, 0x1f, 0x1, 0x0, 0x0, 0x9f, 0x29, 0x1a, 0x0, 0xc, 0x0, 0x0, 0x0, 0xff, 0x7f, 0x7f, 0x2, 0x1f, 0x0, 0x0, 0x0, 0xff, 0x7f, 0xe0, 0x3, 0x6, 0x2, 0x20, 0x1, 0xff, 0x7f, 0xeb, 0x7e, 0x1f, 0x0, 0x0, 0x7c, 0xff, 0x7f, 0xff, 0x3f, 0x0, 0x7e, 0x1f, 0x0, 0xff, 0x7f, 0xff, 0x3, 0x1f, 0x0, 0x0, 0x0, 0xff, 0x3, 0x1f, 0x0, 0xc, 0x0, 0x0, 0x0, 0xff, 0x7f, 0x3f, 0x3, 0x93, 0x1, 0x0, 0x0, 0x0, 0x0, 0x0, 0x42, 0x7f, 0x3, 0xff, 0x7f, 0xff, 0x7f, 0x8c, 0x7e, 0x0, 0x7c, 0x0, 0x0, 0xff, 0x7f, 0xef, 0x1b, 0x80, 0x61, 0x0, 0x0, 0xff, 0x7f, 0x0, 0x7c, 0xe0, 0x3, 0x1f, 0x7c, 0x1f, 0x0, 0xff, 0x3, 0x40, 0x41, 0x42, 0x20, 0x21, 0x22, 0x80, 0x81, 0x82, 0x10, 0x11, 0x12, 0x12, 0xb0, 0x79, 0xb8, 0xad, 0x16, 0x17, 0x7, 0xba, 0x5, 0x7c, 0x13, 0x0, 0x0, 0x0, 0x0];
pub struct MMU {
    pub cartridge: Cartridge,
    boot_rom: Option<Vec<u8>>,
    wram: [[u8; 0x1000]; 8], // Working RAM, 8 banks total
    hram: [u8; 0x7F], // aka High Ram or Zero Page

    hdma: [u8; 0x10], // HDMA registers
    hdma_src: u16, // HDMA source address
    hdma_dst: u16, // HDMA destination address
    hdma_len: u8, // HDMA length
    hdma_status: DMAType, // HDMA status

    selected_wram_bank: u8, // 1-7 banks, bank 0 is always available
    pub interrupt_flags: u8, // 7-5: Unused, 4: Joypad, 3: Serial, 2: Timer, 1: LCD, 0: VBlank
    pub interrupt_enable: u8, // Controls whether the interrupt handler should be called, same layout as interrupt flags
    pub joypad: Joypad,
    pub ppu: PPU,
    pub timer: Timer,
    pub sound: Sound,
    gb_mode: GbMode,
}

impl MMU {
    pub fn new(cartridge: Cartridge, gb_mode: GbMode, using_boot_rom: bool, audio_player: Box<dyn AudioPlayer>) -> MMU {
        let boot_rom = if using_boot_rom {
            Some(match gb_mode {
                GbMode::Classic => DMG_BOOT_ROM.to_vec(),
                GbMode::Color => CGB0_BOOT_ROM.to_vec(),
            })
        } else { None };
        let sound = match gb_mode {
            GbMode::Classic => Sound::new_dmg(audio_player),
            GbMode::Color => Sound::new_cgb(audio_player),
        };
        let mut mmu = MMU {
            cartridge,
            boot_rom,
            wram: [[0; 0x1000]; 8],
            hram: [0; 0x7F],

            hdma: [0; 0x10],
            hdma_src: 0,
            hdma_dst: 0,
            hdma_len: 0,
            hdma_status: DMAType::NoDMA,

            selected_wram_bank: 1,
            interrupt_flags: 0b00000,
            interrupt_enable: 0b00000,
            joypad: Joypad::new(),
            ppu: PPU::new(gb_mode),
            timer: Timer::new(),
            sound,
            gb_mode,
        };

        mmu.write_byte(0xFF05, 0);
        mmu.write_byte(0xFF06, 0);
        mmu.write_byte(0xFF07, 0);
        mmu.write_byte(0xFF10, 0x80);
        mmu.write_byte(0xFF11, 0xBF);
        mmu.write_byte(0xFF12, 0xF3);
        mmu.write_byte(0xFF14, 0xBF);
        mmu.write_byte(0xFF16, 0x3F);
        mmu.write_byte(0xFF16, 0x3F);
        mmu.write_byte(0xFF17, 0);
        mmu.write_byte(0xFF19, 0xBF);
        mmu.write_byte(0xFF1A, 0x7F);
        mmu.write_byte(0xFF1B, 0xFF);
        mmu.write_byte(0xFF1C, 0x9F);
        mmu.write_byte(0xFF1E, 0xFF);
        mmu.write_byte(0xFF20, 0xFF);
        mmu.write_byte(0xFF21, 0);
        mmu.write_byte(0xFF22, 0);
        mmu.write_byte(0xFF23, 0xBF);
        mmu.write_byte(0xFF24, 0x77);
        mmu.write_byte(0xFF25, 0xF3);
        mmu.write_byte(0xFF26, 0xF1);
        mmu.write_byte(0xFF40, 0x91);
        mmu.write_byte(0xFF42, 0);
        mmu.write_byte(0xFF43, 0);
        mmu.write_byte(0xFF45, 0);
        mmu.write_byte(0xFF47, 0xFC);
        mmu.write_byte(0xFF48, 0xFF);
        mmu.write_byte(0xFF49, 0xFF);
        mmu.write_byte(0xFF4A, 0);
        mmu.write_byte(0xFF4B, 0);
        mmu
    }

    pub fn reset(&mut self) {
        self.cartridge.reset();
    }

    pub fn step(&mut self, cycles: u32) {
        self.timer.step(cycles);
        self.interrupt_flags |= self.timer.interrupt;
        self.timer.interrupt = 0;

        self.ppu.step(cycles);
        self.interrupt_flags |= self.ppu.interrupt;
        self.ppu.interrupt = 0;

        self.sound.do_cycle(cycles);
    }

    pub fn has_interrupt(&self) -> bool {
        self.interrupt_flags & self.interrupt_enable != 0
    }

    pub fn read_word(&mut self, addr: u16) -> u16 {
        let low = self.read_byte(addr) as u16;
        let high = self.read_byte(addr.wrapping_add(1)) as u16;
        (high << 8) | low
    }

    pub fn write_word(&mut self, addr: u16, value: u16) {
        self.write_byte(addr, value as u8);
        self.write_byte(addr.wrapping_add(1), (value >> 8) as u8);
    }

    pub fn read_byte(&mut self, address: u16) -> u8 {
        if let Some(boot_rom) = &self.boot_rom {
            if address < boot_rom.len() as u16 {
                return boot_rom[address as usize];
            }
        }

        match address {
            0x0000..=0x7FFF => self.cartridge.read_rom(address),
            0x8000..=0x9FFF => self.ppu.read_vram(address - 0x8000),
            0xA000..=0xBFFF => self.cartridge.read_ram(address - 0xA000),
            0xC000..=0xCFFF => self.wram[0][address as usize - 0xC000],
            0xD000..=0xDFFF => self.wram[self.selected_wram_bank as usize][address as usize - 0xD000],
            0xE000..=0xFDFF => {
                // Echo RAM echoes wram bank 0
                let bank = (address as usize - 0xE000) / 0x1000;
                self.wram[bank][(address as usize - 0xE000) % 0x1000]
            }
            0xFE00..=0xFE9F => self.ppu.read_oam(address - 0xFE00),
            0xFEA0..=0xFEFF => 0x00, // Not Usable https://gbdev.io/pandocs/Memory_Map.html#fea0feff-range

            // IO Registers: https://gbdev.io/pandocs/Hardware_Reg_List.html
            0xFF00 => self.joypad.read_byte(),
            0xFF01 => 0, // TODO: Serial Data Transfer
            0xFF02 => 0, // TODO: Serial Data Control
            0xFF03 => 0xFF, // Unused
            0xFF04..=0xFF07 => self.timer.read_byte(address),
            0xFF08..=0xFF0E => 0xFF, // Unused
            0xFF0F => self.interrupt_flags,
            0xFF10..=0xFF3F => self.sound.rb(address),
            0xFF40..=0xFF4B => self.ppu.read_register(address),
            0xFF4C => 0xFF, // Unused
            0xFF4D => 0, // TODO: Speed Switch
            0xFF4E => 0xFF, // Unused
            0xFF4F => self.ppu.selected_vram_bank as u8,
            0xFF50 => 0xFF,
            0xFF51..=0xFF54 => self.hdma[address as usize - 0xFF51],
            0xFF55 => self.hdma_len | bit(self.hdma_status == DMAType::NoDMA, 7),
            0xFF56 => 0, // TODO: Infrared
            0xFF57..=0xFF67 => 0xFF, // Unused
            0xFF68..=0xFF6B => self.ppu.read_register(address),
            0xFF6C => 0, // TODO: CGB Speed Switch
            0xFF6D..=0xFF6F => 0xFF, // Unused
            0xFF70 => self.selected_wram_bank,
            0xFF71..=0xFF75 => 0xFF, // Unused
            0xFF76..=0xFF77 => 0, // TODO: Audio digital output

            0xFF78..=0xFF7F => 0xFF, // Unused
            0xFF80..=0xFFFE => self.hram[address as usize - 0xFF80],

            0xFFFF => self.interrupt_enable,
            _ => unreachable!()
        }
    }

    pub fn write_byte(&mut self, address: u16, value: u8) {
        if let Some(boot_rom) = &mut self.boot_rom {
            if address < boot_rom.len() as u16 {
                boot_rom[address as usize] = value;
            }
        }

        match address {
            0x0000..=0x7FFF => self.cartridge.write_rom(address, value),
            0x8000..=0x9FFF => self.ppu.write_vram(address - 0x8000, value),
            0xA000..=0xBFFF => self.cartridge.write_ram(address - 0xA000, value),
            0xC000..=0xCFFF => self.wram[0][address as usize - 0xC000] = value,
            0xD000..=0xDFFF => self.wram[self.selected_wram_bank as usize][address as usize - 0xD000] = value,
            0xE000..=0xFDFF => {
                // Echo RAM echoes wram bank 0
                let bank = (address as usize - 0xE000) / 0x1000;
                self.wram[bank][(address as usize - 0xE000) % 0x1000] = value;
            }
            0xFE00..=0xFE9F => self.ppu.write_oam(address - 0xFE00, value),
            0xFEA0..=0xFEFF => {} // Not Usable https://gbdev.io/pandocs/Memory_Map.html#fea0feff-range

            // IO Registers: https://gbdev.io/pandocs/Hardware_Reg_List.html
            0xFF00 => self.joypad.write_byte(value),
            0xFF01 => {} // TODO: Serial Data Transfer
            0xFF02 => {} // TODO: Serial Data Control
            0xFF03 => {} // Unused
            0xFF04..=0xFF07 => self.timer.write_byte(address, value),
            0xFF08..=0xFF0E => {} // Unused
            0xFF0F => self.interrupt_flags = value,
            0xFF10..=0xFF3F => self.sound.wb(address, value), // TODO: Sound Registers
            0xFF46 => {
                let base = (value as u16) << 8;
                for i in 0..0xA0 {
                    let b = self.read_byte(base + i);
                    self.write_byte(0xFE00 + i, b);
                }
            }
            0xFF40..=0xFF4B => self.ppu.write_register(address, value),
            0xFF4C => {} // Unused
            0xFF4D => {} // TODO: Speed Switch
            0xFF4E => {} // Unused
            0xFF4F => self.ppu.selected_vram_bank = value > 0,
            0xFF50 => self.boot_rom = None,
            0xFF51 => self.hdma[0] = value,
            0xFF52 => self.hdma[1] = value & 0xF0,
            0xFF53 => self.hdma[2] = value & 0x1F,
            0xFF54 => self.hdma[3] = value & 0xF0,
            0xFF55 => {
                if self.hdma_status == DMAType::HDMA {
                    if is_set(value, 7) {
                        self.hdma_status = DMAType::NoDMA;
                    }
                    return;
                }
                let src = ((self.hdma[0] as u16) << 8) | (self.hdma[1] as u16);
                let dst = ((self.hdma[2] as u16) << 8) | (self.hdma[3] as u16) | 0x8000;
                if src > 0x7FF0 && (src < 0xA000 || src > 0xDFF0) {
                    panic!("HDMA transfer with illegal start address {:04X}", src);
                }

                self.hdma_src = src;
                self.hdma_dst = dst;
                self.hdma_len = value & 0x7F;
                self.hdma_status = if is_set(value, 7) { DMAType::HDMA } else { DMAType::GDMA };
            }
            0xFF56 => {} // TODO: Infrared
            0xFF57..=0xFF67 => {} // Unused
            0xFF68..=0xFF6B => self.ppu.write_register(address, value),
            0xFF6C => {} // TODO: CGB Object Priority Mode
            0xFF6D..=0xFF6F => {} // Unused
            0xFF70 => self.selected_wram_bank = value,
            0xFF71..=0xFF75 => {} // Unused
            0xFF76..=0xFF77 => {} // Audio digital output (read-only)
            0xFF78..=0xFF7F => {} // Unused
            0xFF80..=0xFFFE => self.hram[address as usize - 0xFF80] = value,

            0xFFFF => self.interrupt_enable = value,
            _ => unreachable!("Invalid write address {:04X}", address)
        };
    }

    fn perform_vram_dma(&mut self) -> u32 {
        match self.hdma_status {
            DMAType::NoDMA => 0,
            DMAType::GDMA => self.perform_gdma(),
            DMAType::HDMA => self.perform_hdma(),
        }
    }

    fn perform_gdma(&mut self) -> u32 {
        let len = self.hdma_len as u32 + 1;
        for _ in 0..len {
            self.perform_vram_dma_row();
        }

        self.hdma_status = DMAType::NoDMA;
        len * 8
    }

    fn perform_hdma(&mut self) -> u32 {
        if !self.ppu.hblank {
            return 0;
        }

        self.perform_vram_dma_row();
        if self.hdma_len == 0x7F {
            self.hdma_status = DMAType::NoDMA;
        }
        8
    }

    fn perform_vram_dma_row(&mut self) {
        let mmu_src = self.hdma_src;
        for i in 0..0x10 {
            let byte = self.read_byte(mmu_src + i);
            self.write_byte(self.hdma_dst + i, byte);
        }
        self.hdma_src += 0x10;
        self.hdma_dst += 0x10;

        if self.hdma_len == 0 {
            self.hdma_len = 0x7F;
        } else {
            self.hdma_len = self.hdma_len.wrapping_sub(1);
        }
    }
}
